<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin ‚Äî Usu√°rios | Natrip Aventura</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- header injetado por js/main.js -->

<!-- Modal para exibir lista de convidados -->
<div id="referral-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
        <button onclick="closeReferralModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        <h3 id="referral-modal-title" style="margin: 0 0 20px 0; color: #333;">Convidados</h3>
        <div id="referral-modal-content">
            <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
    </div>
</div>

<section class="perfil-container">
    <div class="perfil-card">
        <h2>Usu√°rios Cadastrados</h2>
        <div id="admin-msg" style="margin-bottom:12px;color:#c33;"></div>
        <div id="users-list">
            <!-- tabela de usu√°rios ser√° inserida aqui -->
        </div>
    </div>
</section>

<footer>
    <p>¬© 2026 Natrip Aventura</p>
</footer>

<script src="js/main.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const auth = window.natripAuth;
    const current = auth ? auth.getCurrentUser() : JSON.parse(localStorage.getItem('natrip_currentUser') || 'null');
    const msg = document.getElementById('admin-msg');
    const list = document.getElementById('users-list');

    if (!current) {
        msg.textContent = 'Acesso restrito: fa√ßa login como administrador.';
        return;
    }

    // busca usu√°rios no servidor
    let users = [];
    async function loadUsers() {
        try {
            const resp = await fetch('/api/users');
            if (!resp.ok) {
                msg.textContent = 'Erro ao carregar usu√°rios do servidor.';
                return false;
            }
            users = await resp.json();
            return true;
        } catch (e) {
            msg.textContent = 'N√£o foi poss√≠vel conectar ao servidor.';
            return false;
        }
    }

    const ok = await loadUsers();
    if (!ok) return;
    
    // Carregar dados de convidados para todos os usu√°rios
    const referralCounts = {};
    async function loadAllReferrals() {
        const promises = users.map(async (u) => {
            try {
                const resp = await fetch(`/api/referrals?email=${encodeURIComponent(u.email)}`);
                if (resp.ok) {
                    const data = await resp.json();
                    referralCounts[u.email] = data;
                }
            } catch (e) {
                console.error('Error loading referrals for', u.email, e);
            }
        });
        await Promise.all(promises);
    }
    
    await loadAllReferrals();

    // Verifica role no registro completo retornado pelo servidor
    const full = users.find(u => u.email === current.email);
    if (!full || full.role !== 'admin') {
        msg.textContent = 'Acesso negado. Esta √°rea √© somente para administradores.';
        return;
    }

    if (!users || users.length === 0) {
        list.innerHTML = '<p>Nenhum usu√°rio cadastrado.</p>'; return;
    }

    // adiciona campo de pesquisa acima da listagem (est√°tico no DOM)
    const searchContainer = document.createElement('div');
    searchContainer.style.margin = '12px 0';
    searchContainer.innerHTML = `<input id="user-search" placeholder="Pesquisar (nome, e-mail, CPF, telefone, role)" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" />`;
    // insere antes da listagem
    list.parentNode.insertBefore(searchContainer, list);

    // estado de busca
    let searchQuery = '';
    function matches(u, q) {
        if (!q) return true;
        q = q.toLowerCase();
        return (u.name || '').toLowerCase().includes(q)
            || (u.email || '').toLowerCase().includes(q)
            || (u.cpf || '').toLowerCase().includes(q)
            || (u.phone || '').toLowerCase().includes(q)
            || (u.role || '').toLowerCase().includes(q);
    }

    // renderiza tabela filtrando pela busca
    function render() {
        const rows = users.map((u, i) => {
            const refData = referralCounts[u.email] || { count: 0, referrals: [] };
            return matches(u, searchQuery) ? `
            <tr data-index="${i}">
                <td class="col-name">${u.name || ''}</td>
                <td class="col-email">${u.email || ''}</td>
                <td class="col-cpf">${u.cpf || ''}</td>
                <td class="col-phone">${u.phone || ''}</td>
                <td class="col-role">${u.role || 'user'}</td>
                <td class="col-referrals" style="text-align: center;">
                    <span style="font-weight: 600; color: #0a7;">${refData.count}</span>
                    ${refData.count > 0 ? `<button class="icon-btn referral-btn" title="Ver convidados" data-email="${u.email}" style="margin-left: 6px;">üë•</button>` : ''}
                </td>
                <td class="col-trips"><button class="icon-btn view-btn" title="Ver viagens" data-email="${u.email}">üëÅ</button></td>
                <td class="col-actions">
                    <div class="action-buttons">
                        <button class="icon-btn edit-btn" title="Editar" data-index="${i}">‚úé</button>
                    </div>
                </td>
            </tr>
        ` : ''}).join('');

        list.innerHTML = `
            <div style="overflow:auto">
            <table style="width:100%;border-collapse:separate; border-spacing:0 12px;">
                <thead>
                    <tr style="text-align:left;background:#f4f4f4"><th>Nome</th><th>E-mail</th><th>CPF</th><th>Telefone</th><th>Role</th><th style="text-align:center;">Convidados</th><th>Viagens</th><th></th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            </div>
            <div style="margin-top:12px; display:flex; align-items:center; gap:12px;">
                <button id="add-user-btn" class="add-user-btn" title="Adicionar usu√°rio">Ôºã</button>
                <div id="add-user-form" style="display:none; width:100%;">
                    <div class="add-user-form">
                        <div class="add-user-inputs" style="display:flex; gap:8px; flex-wrap:wrap; flex:1;">
                            <input id="new-name" class="medium" placeholder="Nome" />
                            <input id="new-email" class="medium" placeholder="E-mail" />
                            <input id="new-cpf" class="small" placeholder="CPF" />
                            <input id="new-phone" class="small" placeholder="Telefone" />
                            <input id="new-password" class="small" placeholder="Senha" />
                            <input id="new-role" class="small" placeholder="Role (user/admin)" />
                        </div>
                        <div class="add-user-actions">
                            <button id="new-save" class="save-btn">Salvar</button>
                            <button id="new-cancel" class="cancel-btn">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        attachHandlers();
    }

    // inicial render
    render();

    // Fun√ß√µes de edi√ß√£o inline
    function startEdit(index) {
        const tr = list.querySelector(`tbody tr[data-index="${index}"]`);
        if (!tr) return;
        const user = users[index];
        tr.querySelector('.col-name').innerHTML = `<input class="edit-name" value="${(user.name||'').replace(/\"/g,'&quot;')}" />`;
        tr.querySelector('.col-email').innerHTML = `<input class="edit-email" value="${(user.email||'').replace(/\"/g,'&quot;')}" />`;
        tr.querySelector('.col-cpf').innerHTML = `<input class="edit-cpf" value="${(user.cpf||'').replace(/\"/g,'&quot;')}" />`;
        tr.querySelector('.col-phone').innerHTML = `<input class="edit-phone" value="${(user.phone||'').replace(/\"/g,'&quot;')}" />`;
        tr.querySelector('.col-role').innerHTML = `<input class="edit-role" value="${(user.role||'user').replace(/\"/g,'&quot;')}" />`;
        tr.querySelector('.col-actions').innerHTML = `<div class="action-buttons"><button class="save-btn" data-index="${index}">Salvar</button><button class="cancel-btn" data-index="${index}">Cancelar</button></div>`;

        // attach listeners for the newly created buttons
        const saveBtn = tr.querySelector('.save-btn');
        const cancelBtn = tr.querySelector('.cancel-btn');
        if (saveBtn) saveBtn.addEventListener('click', () => saveEdit(index));
        if (cancelBtn) cancelBtn.addEventListener('click', () => cancelEdit(index));
    }

    function cancelEdit(index) {
        // re-render full list for simplicity
        render();
    }

    async function saveEdit(index) {
        const tr = list.querySelector(`tbody tr[data-index="${index}"]`);
        if (!tr) return;
        const name = tr.querySelector('.edit-name').value.trim();
        const email = tr.querySelector('.edit-email').value.trim().toLowerCase();
        const cpf = tr.querySelector('.edit-cpf').value.trim();
        const phone = tr.querySelector('.edit-phone').value.trim();
        const role = tr.querySelector('.edit-role').value.trim() || 'user';

        // basic validation: email not empty
        if (!email) { alert('E-mail n√£o pode ficar vazio.'); return; }

        // update users array and persist to backend (upsert)
        users[index] = { ...users[index], name, email, cpf, phone, role };
        try {
            await fetch('/api/users/upsert', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ users: [users[index]] })
            });
        } catch (e) {
            alert('Falha ao salvar no servidor. Tente novamente.');
            return;
        }
        // update header in case admin changed own name/email
        if (window.natripAuth && window.natripAuth.updateHeaderAuth) window.natripAuth.updateHeaderAuth();
        render();
    }

    function attachHandlers() {
        // search input handler
        const searchInputEl = document.getElementById('user-search');
        if (searchInputEl) {
            searchInputEl.addEventListener('input', (ev) => {
                searchQuery = (ev.currentTarget.value || '').trim();
                render();
            });
        }
        list.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (ev) => {
            const idx = ev.currentTarget.dataset.index; startEdit(idx);
        }));
        // view trips button: redirect admin to the user's bookings page
        list.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', (ev) => {
            const email = ev.currentTarget.dataset.email;
            if (!email) return;
            window.location.href = `minhas-compras.html?user=${encodeURIComponent(email)}`;
        }));
        // referral button: show modal with list of referrals
        list.querySelectorAll('.referral-btn').forEach(btn => btn.addEventListener('click', (ev) => {
            const email = ev.currentTarget.dataset.email;
            if (!email) return;
            showReferralModal(email);
        }));
        // dates button removed; admin manages trips in `admin-viajens.html`
        // add user button toggles the form
        const addBtn = document.getElementById('add-user-btn');
        if (addBtn) addBtn.addEventListener('click', () => {
            const formWrap = document.getElementById('add-user-form');
            if (!formWrap) return;
            formWrap.style.display = formWrap.style.display === 'none' ? '' : 'none';
        });
        // new user form actions
        const newSave = document.getElementById('new-save');
        const newCancel = document.getElementById('new-cancel');
        if (newCancel) newCancel.addEventListener('click', () => { const fw = document.getElementById('add-user-form'); if (fw) fw.style.display = 'none'; });
        if (newSave) newSave.addEventListener('click', async () => {
            const name = document.getElementById('new-name').value.trim();
            const email = (document.getElementById('new-email').value || '').trim().toLowerCase();
            const cpf = document.getElementById('new-cpf').value.trim();
            const phone = document.getElementById('new-phone').value.trim();
            const password = document.getElementById('new-password').value || '';
            const role = (document.getElementById('new-role').value || 'user').trim();
            if (!email) { alert('E-mail obrigat√≥rio'); return; }
            if (users.find(u => u.email === email)) { alert('J√° existe usu√°rio com este e-mail'); return; }
            const newUser = { name, email, cpf, phone, password, role };
            try {
                const resp = await fetch('/api/users/upsert', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users: [newUser] })
                });
                if (!resp.ok) { alert('Falha ao criar usu√°rio no servidor.'); return; }
                await loadUsers();
            } catch (e) {
                alert('N√£o foi poss√≠vel conectar ao servidor.');
                return;
            }
            const fw = document.getElementById('add-user-form'); if (fw) fw.style.display = 'none';
            render();
        });
    }

    // inicial
    attachHandlers();

    // per-user dates removed; admin will manage trips in `admin-viajens.html`
    
    // Modal functions
    window.showReferralModal = function(email) {
        const refData = referralCounts[email];
        const user = users.find(u => u.email === email);
        
        if (!refData || !user) return;
        
        const modal = document.getElementById('referral-modal');
        const title = document.getElementById('referral-modal-title');
        const content = document.getElementById('referral-modal-content');
        
        title.textContent = `Convidados de ${user.name}`;
        
        if (refData.count === 0) {
            content.innerHTML = '<p style="color: #999; text-align: center;">Nenhum convidado ainda.</p>';
        } else {
            content.innerHTML = refData.referrals.map((ref, index) => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                    <div style="width: 25px; height: 25px; background: #0a7; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">
                        ${index + 1}
                    </div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 600; color: #333; font-size: 14px;">${ref.name}</p>
                        <p style="margin: 3px 0 0 0; font-size: 12px; color: #999;">${ref.email}</p>
                    </div>
                </div>
            `).join('');
        }
        
        modal.style.display = 'flex';
    };
    
    window.closeReferralModal = function() {
        const modal = document.getElementById('referral-modal');
        modal.style.display = 'none';
    };
    
    // Fechar modal clicando fora
    document.getElementById('referral-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReferralModal();
        }
    });
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin — Viajens | Natrip Aventura</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- header injected by js/main.js -->

<section class="perfil-container">
    <div class="perfil-card">
        <h2>Gerenciar Viajens</h2>
        <div id="admin-msg" style="margin-bottom:12px;color:#c33;"></div>

        <div style="display:flex; gap:8px; margin-bottom:12px;">
            <button id="tab-trips" class="tab-btn active">Viagens</button>
            <button id="tab-banners" class="tab-btn">Banners</button>
        </div>

        <div id="trips-section">
        <div class="admin-fields" style="display:flex;flex-direction:column;gap:12px;align-items:flex-start;margin-bottom:12px;">
            <div class="form-field" style="width:100%;">
                <label for="trip-category">Categoria</label>
                <select id="trip-category" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;">
                    <option value="cidades-historicas">Cidades Históricas</option>
                    <option value="trilhas-e-cachoeiras">Trilhas e Cachoeiras</option>
                    <option value="bate-volta">Bate-Volta</option>
                </select>
            </div>

            <div class="form-field" style="width:100%;">
                <label for="trip-city">Local da Viagem</label>
                <select id="trip-city" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;">
                    <option value="Ouro Preto">Ouro Preto</option>
                    <option value="Tiradentes">Tiradentes</option>
                    <option value="Mariana">Mariana</option>
                    <option value="Diamantina">Diamantina</option>
                    <option value="Sao Joao del-Rei">São João del-Rei</option>
                    <option value="Congonhas">Congonhas</option>
                    <option value="outros">Outros...</option>
                </select>
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-date">Data da Viagem</label>
                <input id="trip-date" type="date" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-departure">Horário de Saída</label>
                <input id="trip-departure" type="time" step="300" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-departure-address">Endereço de Saída</label>
                <input id="trip-departure-address" type="text" placeholder="Endereço / ponto de encontro" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-seats">Vagas</label>
                <input id="trip-seats" type="number" min="1" value="1" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:120px;" />
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-price">Valor (R$)</label>
                <input id="trip-price" type="number" min="0" step="0.01" placeholder="0.00" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:160px;" />
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-desc">Descrição (exibida no detalhe)</label>
                <textarea id="trip-desc" rows="4" placeholder="Descrição da viagem" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;"></textarea>
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-points">Pontos de Interesse (uma linha por item)</label>
                <textarea id="trip-points" rows="3" placeholder="Ex: Mirante\nTrilha curta\nCachoeira" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;"></textarea>
            </div>
            <div class="form-field" style="width:100%;">
                <label for="trip-cover-url">Capa (URL)</label>
                <input id="trip-cover-url" type="url" placeholder="https://.../imagem.jpg" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                    <input id="trip-cover-file" type="file" accept="image/*" style="flex:0 0 auto;" />
                    <img id="trip-cover-preview" src="" alt="Preview" style="width:96px;height:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd;display:none;" />
                </div>
            </div>
            <div style="width:100%;display:flex;justify-content:flex-end;">
                <button id="trip-add" class="save-btn">Criar Viagem</button>
            </div>
        </div>

        <div id="trips-list"></div>
        </div><!-- end trips-section -->

        <div id="banners-section" style="display:none;">
            <div style="display:flex;flex-direction:column;gap:12px;align-items:flex-start;margin-bottom:12px;">
                <div class="form-field" style="width:100%;">
                    <label for="banner-title">Título</label>
                    <input id="banner-title" type="text" placeholder="Ex: Cidades Históricas" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
                </div>
                <div class="form-field" style="width:100%;">
                    <label for="banner-subtitle">Subtítulo (opcional)</label>
                    <input id="banner-subtitle" type="text" placeholder="Breve descrição" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
                </div>
                <div class="form-field" style="width:100%;">
                    <label for="banner-category">Categoria / Slug</label>
                    <input id="banner-category" type="text" placeholder="cidades-historicas" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
                </div>
                <div class="form-field" style="width:100%;">
                    <label for="banner-image-url">Imagem (URL)</label>
                    <input id="banner-image-url" type="url" placeholder="https://.../imagem.jpg" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
                    <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                        <input id="banner-image-file" type="file" accept="image/*" style="flex:0 0 auto;" />
                        <img id="banner-image-preview" src="" alt="Preview" style="width:140px;height:90px;object-fit:cover;border-radius:6px;border:1px solid #ddd;display:none;" />
                    </div>
                </div>
                <div class="form-field" style="width:100%;">
                    <label for="banner-link">Link alvo (opcional)</label>
                    <input id="banner-link" type="url" placeholder="/natureza.html" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;" />
                </div>
                <div class="form-field" style="width:100%;">
                    <label for="banner-order">Ordem (número)</label>
                    <input id="banner-order" type="number" value="0" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:120px;" />
                </div>
                <div style="width:100%;display:flex;justify-content:flex-end;gap:8px;">
                    <button id="banner-add" class="save-btn">Criar Banner</button>
                    <button id="banner-cancel" class="save-btn" style="background:#ccc;color:#222;border:none;">Cancelar</button>
                </div>
            </div>

            <div id="banners-list" style="margin-top:12px;"></div>
        </div>
    </div>
</section>

<footer>
    <p>© 2026 Natrip Aventura</p>
</footer>

<script src="js/main.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const auth = window.natripAuth;
    const current = auth ? auth.getCurrentUser() : JSON.parse(localStorage.getItem('natrip_currentUser')||'null');
    const msg = document.getElementById('admin-msg');
    if (!current) { msg.textContent='Acesso restrito: faça login como administrador.'; return; }

    async function checkAdmin() {
        try {
            const resp = await fetch('/api/users');
            if (!resp.ok) { msg.textContent='Erro ao verificar permissões.'; return false; }
            const users = await resp.json();
            const full = users.find(u => u.email === current.email);
            if (!full || full.role !== 'admin') { msg.textContent='Acesso negado. Somente administradores.'; return false; }
            return true;
        } catch (e) { msg.textContent='Não foi possível conectar ao servidor.'; return false; }
    }

    function showAdminToast(text, timeout=2500){
        let el = document.getElementById('admin-toast');
        if (!el) {
            el = document.createElement('div'); el.id='admin-toast';
            el.style.position='fixed'; el.style.right='20px'; el.style.bottom='20px'; el.style.background='#0a7'; el.style.color='#fff';
            el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.boxShadow='0 6px 18px rgba(0,0,0,0.12)'; el.style.zIndex=9999;
            document.body.appendChild(el);
        }
        el.textContent = text; el.style.opacity = '1'; el.style.transition='opacity 300ms';
        if (timeout>0) setTimeout(()=>{ el.style.opacity='0'; }, timeout);
    }

    function setMinDate() {
        const dateEl = document.getElementById('trip-date');
        if (!dateEl) return;
        const now = new Date();
        const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0'); const dd = String(now.getDate()).padStart(2,'0');
        const min = `${yyyy}-${mm}-${dd}`;
        dateEl.min = min; if (!dateEl.value) dateEl.value = min;
    }

    // dynamic 'Outros...' city input
    function initCityOther() {
        const citySelect = document.getElementById('trip-city');
        if (!citySelect) return;
        citySelect.addEventListener('change', (e)=>{
            const val = e.target.value; const existing = document.getElementById('trip-city-wrapper');
            if (val === 'outros') {
                if (!existing) {
                    const wrapper = document.createElement('div'); wrapper.id='trip-city-wrapper'; wrapper.className='form-field'; wrapper.style.width='100%';
                    const input = document.createElement('input'); input.id='trip-city-other'; input.type='text'; input.placeholder='Digite o local da viagem'; input.style.cssText='padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;';
                    wrapper.appendChild(input);
                    const selectContainer = citySelect.closest('.form-field') || citySelect.parentNode;
                    selectContainer.parentNode.insertBefore(wrapper, selectContainer.nextSibling);
                }
            } else {
                if (existing) existing.remove();
            }
        });
    }

    async function loadTrips(){ try { const r = await fetch('/api/trips'); if(!r.ok) return []; return await r.json(); } catch(e){ return []; } }
    async function deleteTrip(id){ try { const r = await fetch('/api/trips/delete',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }); return r.ok; } catch(e){ return false; } }

    async function render(){
        const listEl = document.getElementById('trips-list'); if(!listEl) return;
        const trips = await loadTrips();
        if (!trips || trips.length===0){ listEl.innerHTML = '<p>Sem viagens criadas.</p>'; return; }
        listEl.innerHTML = trips.map(t=>{
            const dep = t.departureTime ? ` • Saída: ${t.departureTime}` : '';
            const ret = t.returnTime ? ` • Volta: ${t.returnTime}` : '';
            const desc = t.description || t.desc || '';
            return `<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:12px;background:#fff;border-radius:8px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);"><div><strong>${t.city}</strong><div style="font-size:0.95rem;color:#666;margin-top:6px;">Data: ${t.date} • Vagas: ${t.seats||0}${dep}${ret}</div>${desc ? `<div style="margin-top:8px;color:#444;font-size:0.95rem">${desc}</div>` : ''}</div><div style="display:flex;gap:8px;"><button class="remove-trip" data-id="${t.id}" style="background:#d9534f;color:#fff;border:none;padding:6px 10px;border-radius:6px;">Remover</button></div></div>`;
        }).join('');
        listEl.querySelectorAll('.remove-trip').forEach(b=>b.addEventListener('click', async ev=>{ const id=ev.currentTarget.dataset.id; const ok=await deleteTrip(id); if(ok) render(); else alert('Falha ao remover viagem.'); }));
    }

    function initCoverPreview(){
        const coverFileEl = document.getElementById('trip-cover-file');
        const coverPreview = document.getElementById('trip-cover-preview');
        const coverUrlInput = document.getElementById('trip-cover-url');
        if (coverFileEl) {
            coverFileEl.addEventListener('change', (e)=>{
                const f = e.target.files && e.target.files[0]; if (!f) return; const reader = new FileReader();
                reader.onload = ()=>{ const data = reader.result; if (coverUrlInput) coverUrlInput.value = data; if (coverPreview){ coverPreview.src = data; coverPreview.style.display='inline-block'; } };
                reader.readAsDataURL(f);
            });
        }
        if (coverUrlInput) {
            coverUrlInput.addEventListener('input', (e)=>{ const v = e.target.value.trim(); if (coverPreview){ if (v){ coverPreview.src = v; coverPreview.style.display='inline-block'; } else { coverPreview.src=''; coverPreview.style.display='none'; } } });
        }
    }

    // ===== BANNERS: preview/load/save/delete =====
    async function loadBanners(){ try { const r = await fetch('/api/banners'); if(!r.ok) return []; return await r.json(); } catch(e){ return []; } }
    async function deleteBanner(id){ try { const r = await fetch('/api/banners/delete',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) }); return r.ok; } catch(e){ return false; } }

    async function renderBanners(){
        const listEl = document.getElementById('banners-list'); if(!listEl) return;
        const banners = await loadBanners();
        if (!banners || banners.length===0){ listEl.innerHTML = '<p>Sem banners criados.</p>'; return; }
        listEl.innerHTML = banners.map(b=>{
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#fff;border-radius:8px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);">
                <div style="display:flex;gap:12px;align-items:center;"><img src="${b.image||''}" style="width:120px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #eee;" alt=""><div><strong>${(b.title||'').replace(/</g,'&lt;')}</strong><div style="font-size:0.95rem;color:#666;margin-top:6px;">${(b.subtitle||'').replace(/</g,'&lt;')}</div></div></div>
                <div style="display:flex;gap:8px;align-items:center;"><button class="edit-banner" data-id="${b.id}" style="background:#0a7;color:#fff;border:none;padding:6px 10px;border-radius:6px;">Editar</button><button class="remove-banner" data-id="${b.id}" style="background:#d9534f;color:#fff;border:none;padding:6px 10px;border-radius:6px;">Remover</button></div>
            </div>`;
        }).join('');
        listEl.querySelectorAll('.remove-banner').forEach(b=>b.addEventListener('click', async ev=>{ const id=ev.currentTarget.dataset.id; const ok=await deleteBanner(id); if(ok){ try { localStorage.setItem('natrip_admin_banners_updated_at', new Date().toISOString()); } catch(e){}; showAdminToast('Banner removido'); renderBanners(); } else alert('Falha ao remover banner.'); }));
        listEl.querySelectorAll('.edit-banner').forEach(b=>b.addEventListener('click', async ev=>{
            const id = ev.currentTarget.dataset.id; const banners = await loadBanners(); const found = (banners||[]).find(x=>String(x.id)===String(id)); if(!found) return alert('Banner não encontrado');
            document.getElementById('banner-title').value = found.title||'';
            document.getElementById('banner-subtitle').value = found.subtitle||'';
            document.getElementById('banner-category').value = found.category||'';
            document.getElementById('banner-image-url').value = found.image||'';
            const preview = document.getElementById('banner-image-preview'); if(preview){ if(found.image){ preview.src = found.image; preview.style.display='inline-block'; } else { preview.src=''; preview.style.display='none'; } }
            document.getElementById('banner-link').value = found.link||'';
            document.getElementById('banner-order').value = (typeof found.orderIndex !== 'undefined' && found.orderIndex !== null) ? found.orderIndex : 0;
            const btn = document.getElementById('banner-add'); btn.dataset.editId = found.id; btn.textContent = 'Salvar Banner';
            // switch to banners tab if not visible
            document.getElementById('tab-banners').click();
        }));
    }

    function initBannerPreview(){
        const fileEl = document.getElementById('banner-image-file');
        const urlEl = document.getElementById('banner-image-url');
        const preview = document.getElementById('banner-image-preview');
        if (fileEl) {
            fileEl.addEventListener('change', (e)=>{
                const f = e.target.files && e.target.files[0]; if (!f) return; const reader = new FileReader();
                reader.onload = ()=>{ const data = reader.result; if (urlEl) urlEl.value = data; if (preview){ preview.src = data; preview.style.display='inline-block'; } };
                reader.readAsDataURL(f);
            });
        }
        if (urlEl) {
            urlEl.addEventListener('input', (e)=>{ const v = e.target.value.trim(); if (preview){ if (v){ preview.src = v; preview.style.display='inline-block'; } else { preview.src=''; preview.style.display='none'; } } });
        }
    }

    function resetBannerForm(){ try { document.getElementById('banner-title').value=''; document.getElementById('banner-subtitle').value=''; document.getElementById('banner-category').value=''; document.getElementById('banner-image-url').value=''; const f = document.getElementById('banner-image-file'); if(f) f.value=''; const p=document.getElementById('banner-image-preview'); if(p){ p.src=''; p.style.display='none'; } document.getElementById('banner-link').value=''; document.getElementById('banner-order').value='0'; const btn=document.getElementById('banner-add'); if(btn){ delete btn.dataset.editId; btn.textContent='Criar Banner'; } } catch(e){} }


    function resetForm(){
        try {
            const cityEl = document.getElementById('trip-city'); if(cityEl) cityEl.selectedIndex = 0;
            const other = document.getElementById('trip-city-wrapper'); if (other) other.remove();
            const dateEl = document.getElementById('trip-date'); if (dateEl) dateEl.value = dateEl.min || '';
            const dep = document.getElementById('trip-departure'); if(dep) dep.value='';
            const depAddr = document.getElementById('trip-departure-address'); if(depAddr) depAddr.value='';
            const seats = document.getElementById('trip-seats'); if(seats) seats.value='1';
            const coverUrl = document.getElementById('trip-cover-url'); if(coverUrl) coverUrl.value='';
            const coverFile = document.getElementById('trip-cover-file'); if(coverFile) coverFile.value='';
            const coverPreview = document.getElementById('trip-cover-preview'); if(coverPreview){ coverPreview.src=''; coverPreview.style.display='none'; }
            const desc = document.getElementById('trip-desc'); if(desc) desc.value='';
            const points = document.getElementById('trip-points'); if(points) points.value='';
            const price = document.getElementById('trip-price'); if(price) price.value='';
        } catch(e){}
    }

    async function init(){
        const ok = await checkAdmin(); if(!ok) return;
        setMinDate(); initCityOther(); initCoverPreview(); await render();
        initBannerPreview(); await renderBanners();

        const tripAddBtn = document.getElementById('trip-add');
        if (tripAddBtn) {
            tripAddBtn.addEventListener('click', async ()=>{
                const cityEl = document.getElementById('trip-city'); const dateEl = document.getElementById('trip-date'); const categoryEl = document.getElementById('trip-category');
                let city = cityEl ? cityEl.value : '';
                const date = dateEl ? dateEl.value : ''; const category = categoryEl ? categoryEl.value : '';
                if (city === 'outros') { const other = document.getElementById('trip-city-other'); city = other ? other.value.trim() : ''; if(!city) return alert('Digite o local da viagem'); }
                if (!city) return alert('Escolha o local da viagem');
                const departure = document.getElementById('trip-departure') ? document.getElementById('trip-departure').value : '';
                const departureAddress = document.getElementById('trip-departure-address') ? document.getElementById('trip-departure-address').value.trim() : '';
                const cover = document.getElementById('trip-cover-url') ? document.getElementById('trip-cover-url').value.trim() : '';
                const ret = document.getElementById('trip-return') ? document.getElementById('trip-return').value : '';
                const desc = document.getElementById('trip-desc') ? document.getElementById('trip-desc').value.trim() : '';
                const pointsRaw = document.getElementById('trip-points') ? document.getElementById('trip-points').value.trim() : '';
                const points = pointsRaw ? pointsRaw.split(/\r?\n|,/) .map(s=>s.trim()).filter(Boolean) : [];
                const seatsEl = document.getElementById('trip-seats'); const seats = seatsEl ? (parseInt(seatsEl.value,10)||1) : 1;
                if (!date) return alert('Escolha uma data'); if (dateEl && dateEl.min && date < dateEl.min) return alert('Escolha uma data igual ou posterior a hoje');
                const priceVal = document.getElementById('trip-price') ? document.getElementById('trip-price').value : '';
                const newTrip = { city, date, category, departureTime: departure, departureAddress, returnTime: ret, description: desc, points, seats, price: priceVal, coverImage: cover, createdBy: current.email, createdAt: new Date().toISOString() };
                try {
                    const r = await fetch('/api/trips/upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ trips: [newTrip] }) });
                    if (!r.ok) return alert('Falha ao criar viagem.');
                    // notify other tabs
                    try { localStorage.setItem('natrip_admin_trips_updated_at', new Date().toISOString()); } catch(e){}
                    showAdminToast('Viagem criada com sucesso'); resetForm(); await render();
                } catch(e) { alert('Não foi possível conectar ao servidor.'); }
            });
        }

        // banner add handler
        const bannerAddBtn = document.getElementById('banner-add');
        if (bannerAddBtn) {
            bannerAddBtn.addEventListener('click', async ()=>{
                const title = document.getElementById('banner-title') ? document.getElementById('banner-title').value.trim() : '';
                if (!title) return alert('Preencha o título do banner');
                const subtitle = document.getElementById('banner-subtitle') ? document.getElementById('banner-subtitle').value.trim() : '';
                const category = document.getElementById('banner-category') ? document.getElementById('banner-category').value.trim() : '';
                const image = document.getElementById('banner-image-url') ? document.getElementById('banner-image-url').value.trim() : '';
                const link = document.getElementById('banner-link') ? document.getElementById('banner-link').value.trim() : '';
                const orderIndex = document.getElementById('banner-order') ? parseInt(document.getElementById('banner-order').value,10)||0 : 0;
                const editId = bannerAddBtn.dataset.editId;
                const newBanner = { title, subtitle, category, image, link, orderIndex, createdBy: current.email, createdAt: new Date().toISOString() };
                if (editId) newBanner.id = editId;
                try {
                    const r = await fetch('/api/banners/upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ banners: [newBanner] }) });
                    if (!r.ok) return alert('Falha ao salvar banner.');
                    try { localStorage.setItem('natrip_admin_banners_updated_at', new Date().toISOString()); } catch(e){}
                    showAdminToast(editId ? 'Banner atualizado' : 'Banner criado'); resetBannerForm(); await renderBanners();
                } catch(e) { alert('Não foi possível conectar ao servidor.'); }
            });
        }

        // cancel button
        const bannerCancel = document.getElementById('banner-cancel'); if (bannerCancel) bannerCancel.addEventListener('click', ()=>{ resetBannerForm(); });

        // tabs
        const tabTrips = document.getElementById('tab-trips'); const tabBanners = document.getElementById('tab-banners');
        if (tabTrips && tabBanners) {
            tabTrips.addEventListener('click', ()=>{ document.getElementById('trips-section').style.display='block'; document.getElementById('banners-section').style.display='none'; tabTrips.classList.add('active'); tabBanners.classList.remove('active'); });
            tabBanners.addEventListener('click', ()=>{ document.getElementById('trips-section').style.display='none'; document.getElementById('banners-section').style.display='block'; tabBanners.classList.add('active'); tabTrips.classList.remove('active'); });
        }
    }

    init();
});
</script>
</body>
</html>
